{% assign testing = false %}
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="{{ locale }}" dir="{{ direction }}" class="{{ checkout_html_classes }}">
    <head>

        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0, user-scalable=0">

        <title>{{ page_title }}</title>

        <!-- IMPACT -->
        <script type="text/javascript"> 
            (function(a,b,c,d,e,f,g){e['ire_o']=c;e[c]=e[c]||function(){(e[c].a=e[c].a||[]).push(arguments)};f=d.createElement(b);g=d.getElementsByTagName(b)[0];f.async=1;f.src=a;g.parentNode.insertBefore(f,g);})('//d.impactradius-event.com/A1450394-1267-428a-a5d4-10165976a1d81.js','script','ire',document,window); 
        </script>
        <!-- END IMPACT -->

        {{ content_for_header }}

        {{ checkout_stylesheets }}
        {{ checkout_scripts }}

        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                                                              new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                                    })(window,document,'script','dataLayer','GTM-NWLPSV');</script>
        <!-- End Google Tag Manager -->

        
        <!-- Favicon -->
        <link rel="shortcut icon" href="{{ 'favicon.png' | asset_url }}" type="image/x-icon" />

{% if testing %}
        <!-- Start VWO Async SmartCode -->
        <script type='text/javascript'>
        window._vwo_code = window._vwo_code || (function(){
        var account_id=350881,
        settings_tolerance=2000,
        library_tolerance=2500,
        use_existing_jquery=false,
        is_spa=1,
        hide_element='body',

        /* DO NOT EDIT BELOW THIS LINE */
        f=false,d=document,code={use_existing_jquery:function(){return use_existing_jquery;},library_tolerance:function(){return library_tolerance;},finish:function(){if(!f){f=true;var a=d.getElementById('_vis_opt_path_hides');if(a)a.parentNode.removeChild(a);}},finished:function(){return f;},load:function(a){var b=d.createElement('script');b.src=a;b.type='text/javascript';b.innerText;b.onerror=function(){_vwo_code.finish();};d.getElementsByTagName('head')[0].appendChild(b);},init:function(){
        window.settings_timer=setTimeout('_vwo_code.finish()',settings_tolerance);var a=d.createElement('style'),b=hide_element?hide_element+'{opacity:0 !important;filter:alpha(opacity=0) !important;background:none !important;}':'',h=d.getElementsByTagName('head')[0];a.setAttribute('id','_vis_opt_path_hides');a.setAttribute('type','text/css');if(a.styleSheet)a.styleSheet.cssText=b;else a.appendChild(d.createTextNode(b));h.appendChild(a);this.load('https://dev.visualwebsiteoptimizer.com/j.php?a='+account_id+'&u='+encodeURIComponent(d.URL)+'&f='+(+is_spa)+'&r='+Math.random());return settings_timer; }};window._vwo_settings_timer = code.init(); return code; }());
        </script>
        <!-- End VWO Async SmartCode -->
{% endif %}

    </head>
    <body id="checkout-{{ page_title | handle }}">
        {{ skip_to_content_link }}
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NWLPSV"
                          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->

        {% include 'nowtime' %}
        {% if rightnowint > 201802150001 and rightnowint < 201802262359 %}
                                                                       <div id="sitewidesalebanner" class="freepacificajune2017">
        Treat yourself today. 15% off sitewide with code <strong>PRES15</strong> at checkout.
        </div>
    {% endif %}
    <div class="banner" data-header>
        <div class="wrap">
            {{ content_for_logo }}
        </div>
    </div>

    {{ order_summary_toggle }}

    <div class="content" data-content>
        <div class="wrap">

            <div class="main" role="main">
                <div class="main__header">
                    {{ content_for_logo }}
                    {{ breadcrumb }}
                    {{ alternative_payment_methods }}
                </div>
                <div class="main__content">
                    {{ content_for_layout }}
                </div>
                <div class="main__footer">
                    {{ content_for_footer }}
                </div>
            </div>
            <div class="sidebar" role="complementary">
                <div class="sidebar__header">
                    {{ content_for_logo }}
                </div>
                <div class="sidebar__content">
                    <style>
                        .idme-shopify {
                        /*display: none !important;*/
                        padding: 0 20px;
                        margin-bottom: 15px;
                        }
                        .idme-shopify .idme-btn-affinity A{
                        text-decoration: underline;
                        }
                        .idme-shopify .idme-btn-affinity{
                        font-size: 12px;
                        line-height: 16px;
                        color: black;
                        display: block;
                        margin-bottom: 10px;
                        }
                    </style>
                    {{ content_for_order_summary }}
                </div>
            </div>
        </div>
    </div>

    {%- if settings.plus_checkout_checkbox_enable -%}
      {%- if settings.plus_checkout_product_type != "" -%}
        {%- assign product_found = false -%}
        {%- assign types = settings.plus_checkout_product_type | split: ',' -%}
        
        {%- for item in checkout.line_items -%}
          {%- assign check_type = item.product.type | downcase -%}

          {%- for type in types -%}
            {%- assign set_type = type | downcase | strip -%}
            {%- if set_type == check_type -%}
              {%- assign product_found = true -%}
              {%- assign break_loop = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if break_loop -%}
            {%- break -%}
          {% endif -%}
        {%- endfor -%}
        
        {%- if product_found -%}
          {%- render 'plus-checkout-checkbox' -%}
        {%- endif -%}
      {%- else -%}
        {%- render 'plus-checkout-checkbox' -%}
      {%-endif -%}
    {%- endif -%}

    {{ tracking_code }}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script> 
    </body>
</html>
<style type="text/css">
    p.disclaimer-shipping{
            background-color: bisque;
    padding: 10px 20px;
    border-radius: 6px;
    color: black;
    font-weight: bold; font-size: 14px; margin-top: 10px;
    }
</style>
<script>
    //$(function() {$(".idme-btn-affinity").append(" select mattresses.")});
  $(function() {$("div.section--shipping-method h2#main-header").after("<p class='disclaimer-shipping'>Please note: All our products require production time <span style='text-decoration: underline;'>before</span> they can ship. Check product pages for accurate times or our <a href='https://intercom.help/brentwood-home-b4d83ef0a14f/en/articles/3840166-when-can-i-expect-my-brentwood-home-products-to-arrive' style='text-decoration: underline;' target='_blank'>help center</a>.")});
</script>

{{ 'idme-checkout-style.css' | asset_url | stylesheet_tag }}
{{ 'idme-checkout-template.js' | asset_url | script_tag }}

<script>

$(document).on('page:load page:change', function() {

  var feeName = "Mattress Fee";
  
  function getCartItems() {
    return fetch("/cart.js").then(function(items) {
      return items.json();
    }).then(function(data) {
      return {total: data.total_price, items: data.items};
    }).catch(function(e) {
      return [];
    })
  }
  
  if(Shopify.Checkout.step === "contact_information") {
    var $state_select = $("#checkout_shipping_address_province");
    
    $state_select.on("change", state_changed);
    $state_select.change();
  
    function getMattressFeeVariants() {
      return fetch('/products/mattress-fee.js').then(function(res) {
        return res.json();
      }).then(function(product) {
        var variants = {};
        product.variants.forEach(v => {
          variants[v.title] = {id: v.id}
        });
        return {id: product.id, variants: variants};
      }).catch(function(e) {
        return {};
      });
    }
  
    async function state_changed(e) {
      var value = e.target.value;
      await addFee(value);
    }
  
    async function addFee(variant_name) {
      var cart = await getCartItems();
      var mattresses = cart.items.filter(function(m) { return m.product_type === "Mattress"; });

      var cartHasMattresses = mattresses.length > 0;
      var fee_items = cart.items.filter(function(m) { return m.product_title === feeName; });

      if(cartHasMattresses) {
        addFees(variant_name, mattresses, fee_items);
      } else {
        removeItems(fee_items);
      }
    }
  
    function removeItems(items = []) {
      var update_items = {};
      items.forEach(function(item) {
        update_items[item.variant_id] = 0;
      })
      callUpdate({updates: update_items});
    }

    function updateItem(id, count) {
      var items = {};
      items[id] = count;
      callUpdate({updates: items})
    }
  
    function addItem(id, count) {
      callAdd({items: [{id: id, quantity: count}]}).then(function(data){
        return data;
      });
    }

    function callUpdate(body) {
      return api("/cart/update.js", body);
    }

    function callAdd(body) {
      return api("/cart/add.js", body);
    }

    function api(url, body) {
      return fetch(url, {
        method: "POST",
        headers: {
          'Content-Type': "application/json"
        },
        body: JSON.stringify(body)
      }).then(function(resp) {
        return resp.json();
      }).then(function(cart) {
        fetch(window.location).then(function(e) {
          updateOrderSummary(cart.items);
        });
        return cart;
      })
    }

    async function addFees(state, mattresses = [], fee_items = []) {
      var mattress_variants = await getMattressFeeVariants();
      var count = 0;
      mattresses.forEach(function(mattress) {
        count += mattress.quantity;
      });


      var out_of_range = fee_items.filter(function(fee) {
        return fee.variant_title !== state;
      });
    
      var fee_in_cart = fee_items.filter(function(fee) {
        return fee.variant_title === state;
      });

      if(out_of_range.length > 0) {
        removeItems(out_of_range);
      }
    
      if(fee_in_cart.length > 0) {
        updateItem(fee_in_cart[0].variant_id, count);
       } else {
        if("variants" in mattress_variants && mattress_variants.variants[state]) {
          var id = mattress_variants.variants[state].id;
          addItem(id, count);
        }
      }
    }
  }
  
  function parseToCurrency(num) {
    return (num/100).toFixed(2);
  }

 
    var $sidebar = $(".sidebar__content");
    $sidebar.hide();
  
    function hideOnOrderSummary(id) {
      $("[data-product-id="+ id +"]").hide();
    }

    function createOrderLine(name, name_content, price, price_content) {
      return $(`
          <tr class="total-line total-line--mattress-fee" style="vertical-align: top">
          <th class="total-line__name" style="position: relative;" scope="row">${name}${name_content}</th>
          <td class="total-line__price">
          <span class="order-summary__emphasis" data-checkout-mattress-fee-price-target="${price}">${price_content}
          </span>
          </td>
          </tr>`);
    }
    
    function getMattressLine() {
      return $(".total-line.total-line--mattress-fee");
    }
    function addToOrderSummary(name="", total_price=0, price=0, qty=0) {
      var $list = $(".total-line-table__tbody");
      var $subtotal_line = $(".total-line.total-line--subtotal").first();
      var breakdown_message = "";
      if(qty > 1 && price > 0) {
        breakdown_message = `<span style="font-weight:300">(${qty} x $${parseToCurrency(price)})</span> `;
      };
      
      var $content = createOrderLine(
        name, 
        `<div role="tooltip" class="field__icon has-tooltip" style="display: inline-block;top: 4px;width:25px;">
           <span id="tooltip-for-phone" class="tooltip" style="font-weight: 300; line-height:14px; font-size:13px;">
             CA, CT & RI state law requires us to collect a fee on every mattress to support the state's recycling programs.
           </span>
           <div class="field__icon-svg">
             <svg class="icon-svg icon-svg--color-adaptive-lighter icon-svg--size-16 icon-svg--block" role="presentation" aria-hidden="true" focusable="false"> <use xlink:href="#question" /></svg>
           </div>
         </div>`,
        total_price,
        `${breakdown_message}$${parseToCurrency(total_price)}`
      );
      var $mattress_fee_line = getMattressLine();
      if($mattress_fee_line.length > 0) {
        $mattress_fee_line.replaceWith($content)
      } else {
        $content.insertAfter($subtotal_line);
      }
      var subtotal_data_attr = "checkout-subtotal-price-target";
      var $subtotal = $(`[data-${subtotal_data_attr}]`);
      var subtotal = parseInt($subtotal.data(subtotal_data_attr));
      $subtotal.html(`$${parseToCurrency(subtotal - total_price)}`);
    };
  
    function updateOrderSummary(items, updateTotal) {
      var mattress_item = items.filter(function(item) {
        return item.product_title === feeName;
      });
     
      if(mattress_item.length > 0) {
        var item = mattress_item[0];
        hideOnOrderSummary(item.product_id);
        addToOrderSummary("Mattress Recycling Fee", item.final_line_price, item.price, item.quantity);
        price = item.final_line_price;
        addFeeToTotal(price);
      } else {
        var $mattress_fee_line = getMattressLine();
        $mattress_fee_line.remove();
        removeFeeFromTotal();
      }
    }

    $price = $(".payment-due__price");
    function addFeeToTotal(price) {
      var total = $price.data("checkout-payment-due-target");
      $price.html(`$${parseToCurrency(total + price)}`);
    } 
    function removeFeeFromTotal() {
      var total = $price.data("checkout-payment-due-target");
      $price.html(`$${parseToCurrency(total)}`);
    }
    
    getCartItems().then(function(cart) {
      updateOrderSummary(cart.items);
      $sidebar.show();
    })
  
});

</script>